<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8"/>
	<title>Intino Process Editor</title>
	<link rel="stylesheet" href="https://unpkg.com/bpmn-js@4.1.0-beta.0/dist/assets/diagram-js.css">
	<link rel="stylesheet" href="https://unpkg.com/bpmn-js@4.1.0-beta.0/dist/assets/bpmn-font/css/bpmn.css">
	<script src="https://unpkg.com/bpmn-js@4.1.0-beta.0/dist/bpmn-modeler.development.js"></script>
	<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

	<!-- example styles -->
	<style>
		html, body, #canvas {
			height: 100%;
			padding: 0;
			margin: 0;
		}

		.diagram-note {
			background-color: rgba(66, 180, 21, 0.7);
			color: White;
			border-radius: 5px;
			font-family: Arial;
			font-size: 12px;
			padding: 5px;
			min-height: 16px;
			width: 50px;
			text-align: center;
		}

		.needs-discussion:not(.djs-connection) .djs-visual > :nth-child(1) {
			stroke: rgba(66, 180, 21, 0.7) !important; /* color elements as red */
		}

		#save-button {
			position: fixed;
			bottom: 20px;
			left: 20px;
		}
	</style>
</head>
<body>
<div id="canvas"></div>

<div class="intino toolbar">
	<button id="reset-button">Reset</button>
	<button id="zoom-in-button">Zoom In</button>
	<button id="zoom-out-button">Zoom Out</button>
</div>
<script>
    var process = "$process";
    var diagram = '$diagram';

    if (diagram === "") diagram = defaultDiagram();

    var bpmnModeler = new BpmnJS({
        container: '#canvas',
        keyboard: {
            bindTo: window
        }
    });

    function defaultDiagram() {
        return "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" +
            "<bpmn:definitions xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:bpmn=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" id=\"Definitions_1ep4nie\" targetNamespace=\"http://bpmn.io/schema/bpmn\" exporter=\"bpmn-js (https://demo.bpmn.io)\" exporterVersion=\"4.0.0\">\n" +
            "  <bpmn:process id=\"Process_10wfcih\" isExecutable=\"false\">\n" +
            "    <bpmn:startEvent id=\"StartEvent_0a8dcer\" />\n" +
            "  </bpmn:process>\n" +
            "  <bpmndi:BPMNDiagram id=\"BPMNDiagram_1\">\n" +
            "    <bpmndi:BPMNPlane id=\"BPMNPlane_1\" bpmnElement=\"Process_10wfcih\">\n" +
            "      <bpmndi:BPMNShape id=\"_BPMNShape_StartEvent_2\" bpmnElement=\"StartEvent_0a8dcer\">\n" +
            "        <dc:Bounds x=\"152\" y=\"82\" width=\"36\" height=\"36\" />\n" +
            "      </bpmndi:BPMNShape>\n" +
            "    </bpmndi:BPMNPlane>\n" +
            "  </bpmndi:BPMNDiagram>\n" +
            "</bpmn:definitions>\n";
    }

    function openDiagram(bpmnXML) {
        bpmnModeler.importXML(bpmnXML, function (err) {
            if (err) {
                return console.error('could not import BPMN 2.0 diagram', err);
            }
            var canvas = bpmnModeler.get('canvas');
            canvas.zoom('fit-viewport', true);

        });
    }

    function saveDiagram() {
        bpmnModeler.saveXML({format: true}, function (err, xml) {
            if (err) {
                console.error('could not save BPMN 2.0 diagram', err);
                return;
            }
            $.post("/process?" + process, xml);
        });
    }

    $(window).on('beforeunload', function () {
        saveDiagram();
        $.post("/process/closed?" + process);
    });

    $("#reset-button").click(function () {
        modeler.get('canvas').zoom('fit-viewport', true);
    });

    $("#zoom-in-button").click(function () {
        modeler.get('canvas').zoom(modeler.get('canvas').zoom() + 0.3, true);

    });

    $("#zoom-out-button").click(function () {
        modeler.get('canvas').zoom(modeler.get('canvas').zoom() - 0.3, true);
    });

    openDiagram(diagram);
    $('.bjs-powered-by').remove();
</script>
</body>
</html>